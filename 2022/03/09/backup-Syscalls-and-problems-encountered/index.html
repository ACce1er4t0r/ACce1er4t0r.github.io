<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>backup: Syscalls and problems encountered - Normal Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Normal Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Normal Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="In the previous article, we finished setting up the kernel environment. Now let’s try to write a system call to modify or read the nice value of a given process and return the latest nice value and pr"><meta property="og:type" content="article"><meta property="og:title" content="backup: Syscalls and problems encountered"><meta property="og:url" content="http://aslin.site/2022/03/09/backup-Syscalls-and-problems-encountered/"><meta property="og:site_name" content="Normal Blog"><meta property="og:description" content="In the previous article, we finished setting up the kernel environment. Now let’s try to write a system call to modify or read the nice value of a given process and return the latest nice value and pr"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://i.loli.net/2019/10/11/CUWtY8eIc3pLA2i.png"><meta property="og:image" content="https://i.loli.net/2019/10/11/fDSu4HFQITmdsEX.png"><meta property="og:image" content="https://i.loli.net/2019/10/11/v2seCxMulLaZBht.png"><meta property="og:image" content="https://i.loli.net/2019/10/11/bfmVHDtSJzd47OY.png"><meta property="og:image" content="https://i.loli.net/2019/10/11/wCnitzmFkyhZK31.png"><meta property="og:image" content="https://i.loli.net/2019/10/11/AbP95oHvd8zBNZw.png"><meta property="og:image" content="https://i.loli.net/2019/10/11/Poy1enD354MLrBK.png"><meta property="og:image" content="https://i.loli.net/2019/10/11/CUWtY8eIc3pLA2i.png"><meta property="og:image" content="https://i.loli.net/2019/10/11/fDSu4HFQITmdsEX.png"><meta property="og:image" content="https://i.loli.net/2019/10/11/sHCO1f6bwk3hr7d.png"><meta property="og:image" content="https://i.loli.net/2019/10/11/VqLH7NOflsbhPJM.png"><meta property="article:published_time" content="2022-03-09T08:08:21.000Z"><meta property="article:modified_time" content="2022-03-10T07:48:44.527Z"><meta property="article:author" content="ACce1er4t0r"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://i.loli.net/2019/10/11/CUWtY8eIc3pLA2i.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://aslin.site/2022/03/09/backup-Syscalls-and-problems-encountered/"},"headline":"backup: Syscalls and problems encountered","image":["https://i.loli.net/2019/10/11/CUWtY8eIc3pLA2i.png","https://i.loli.net/2019/10/11/fDSu4HFQITmdsEX.png","https://i.loli.net/2019/10/11/v2seCxMulLaZBht.png","https://i.loli.net/2019/10/11/bfmVHDtSJzd47OY.png","https://i.loli.net/2019/10/11/wCnitzmFkyhZK31.png","https://i.loli.net/2019/10/11/AbP95oHvd8zBNZw.png","https://i.loli.net/2019/10/11/Poy1enD354MLrBK.png","https://i.loli.net/2019/10/11/CUWtY8eIc3pLA2i.png","https://i.loli.net/2019/10/11/fDSu4HFQITmdsEX.png","https://i.loli.net/2019/10/11/sHCO1f6bwk3hr7d.png","https://i.loli.net/2019/10/11/VqLH7NOflsbhPJM.png"],"datePublished":"2022-03-09T08:08:21.000Z","dateModified":"2022-03-10T07:48:44.527Z","author":{"@type":"Person","name":"ACce1er4t0r"},"publisher":{"@type":"Organization","name":"Normal Blog","logo":{"@type":"ImageObject","url":"http://aslin.site/img/book-one.svg"}},"description":"In the previous article, we finished setting up the kernel environment. Now let’s try to write a system call to modify or read the nice value of a given process and return the latest nice value and pr"}</script><link rel="canonical" href="http://aslin.site/2022/03/09/backup-Syscalls-and-problems-encountered/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/book-one.svg" alt="Normal Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/resume.pdf">Resume</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-03-09T08:08:21.000Z" title="3/9/2022, 3:08:21 AM">2022-03-09</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-03-10T07:48:44.527Z" title="3/10/2022, 2:48:44 AM">2022-03-10</time></span><span class="level-item">9 minutes read (About 1378 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">backup: Syscalls and problems encountered</h1><div class="content"><p>In the previous article, we finished setting up the kernel environment. Now let’s try to write a system call to modify or read the nice value of a given process and return the latest nice value and priority prio of the process.</p>
<span id="more"></span>

<h2 id="Successful-method"><a href="#Successful-method" class="headerlink" title="Successful method"></a>Successful method</h2><p>This is a successful method and seems to be the one most people use</p>
<p>First, go to <code>include/linux/syscalls.h</code> and add the following function prototype</p>
<p><img src="https://i.loli.net/2019/10/11/CUWtY8eIc3pLA2i.png" alt="image.png"></p>
<p>After that, go to <code>arch/x86/entry/syscalls/syscall_32.tbl</code> and <code>arch/x86/entry/syscalls/syscall_64.tbl</code> respectively and add the system call number</p>
<p><img src="https://i.loli.net/2019/10/11/fDSu4HFQITmdsEX.png" alt="image.png"></p>
<p>ps:Make sure to add <code>__ia32_</code> to <code>syscall_32.tbl</code> and <code>__x64_</code> to <code>syscall_64.tbl</code>, just like the picture above, otherwise you may get an error like <code>underfined reference to xxx</code>.</p>
<p>Add code in <code>kernel/sys.c</code></p>
<p><img src="https://i.loli.net/2019/10/11/v2seCxMulLaZBht.png" alt="image.png"></p>
<p>After that just <code>make -j8 bzImage</code> and wait for a few minutes</p>
<p>After compiling, write a demo to see if it works</p>
<p><img src="https://i.loli.net/2019/10/11/bfmVHDtSJzd47OY.png" alt="image.png"></p>
<p>Then use the script to make the rootfs.img and launch qemu</p>
<p><img src="https://i.loli.net/2019/10/11/wCnitzmFkyhZK31.png" alt="image.png"></p>
<p>Let’s talk about this syscall</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE5(lab1, <span class="type">pid_t</span>, pid, <span class="type">int</span>, flag, <span class="type">int</span>, nicevalue, <span class="type">void</span> __user *, prio, <span class="type">void</span> __user *, nice) &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> * <span class="title">mypid</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> * <span class="title">task</span>;</span></span><br><span class="line">	<span class="type">int</span> nice_before;</span><br><span class="line">	<span class="type">int</span> nice_after;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// First, we use the function find_get_pid() here to get the struct_pid structure of the pid we are requesting</span></span><br><span class="line">	mypid = find_get_pid(pid);</span><br><span class="line">    <span class="comment">// Then we use the pid_task() function to get the pid corresponding task_struct structure for task_nice() and set_user_nice()</span></span><br><span class="line">	task = pid_task(mypid, PIDTYPE_PID);</span><br><span class="line">	nice_before = task_nice(task);  <span class="comment">// Get the current nice value</span></span><br><span class="line">	<span class="keyword">if</span>(flag == <span class="number">1</span>) &#123;</span><br><span class="line">		set_user_nice(task, nicevalue);  <span class="comment">// Modify nice value</span></span><br><span class="line">		printk(<span class="string">&quot;This is origin nice : %d\nThis is the nice now : %d\n&quot;</span>, nice_before, nicevalue);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(flag == <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;The nice is : %d\n&quot;</span>, nice_before);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	copy_to_user(void __user *to, const void *from, unsigned long n)</span></span><br><span class="line"><span class="comment">	The three parameters are the user memory address, the kernel space address and the data length</span></span><br><span class="line"><span class="comment">	 * user memory address, use (int *)prio</span></span><br><span class="line"><span class="comment">	 * Kernel space address, mainly about task_struct structure, use &amp;task_struct</span></span><br><span class="line"><span class="comment">	 * Data length is the length of this prio, sizeof(task_prio)</span></span><br><span class="line"><span class="comment">	The same goes for the nice value returned later</span></span><br><span class="line"><span class="comment">	**/</span></span><br><span class="line">	<span class="keyword">if</span>(copy_to_user((<span class="type">int</span> *)prio, &amp;task-&gt;prio, <span class="keyword">sizeof</span>(task-&gt;prio))) &#123;</span><br><span class="line">		<span class="keyword">return</span> EFAULT;</span><br><span class="line">	&#125;</span><br><span class="line">	nice_after = task_nice(task);</span><br><span class="line">	<span class="keyword">if</span>(copy_to_user((<span class="type">int</span> *)nice, &amp;nice_after, <span class="keyword">sizeof</span>(nice_after))) &#123;</span><br><span class="line">		<span class="keyword">return</span> EFAULT;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There seems to be a lot of questions though…. Didn’t think about the range of nice values when I first wrote it (didn’t even know nice values had a range).</p>
<h2 id="It’s-an-error-way-that-somehow-goes-wrong"><a href="#It’s-an-error-way-that-somehow-goes-wrong" class="headerlink" title="It’s an error way that somehow goes wrong"></a>It’s an error way that somehow goes wrong</h2><p>At first, I wanted to follow a tutorial on the Internet and try to write a method with parameters, similar to the one I wrote in the last blog about adding system calls.</p>
<p>Create <code>lab1_v2</code> folder in the root of the source code and add <code>lab1_v2.c</code> and <code>Makefile</code></p>
<p><img src="https://i.loli.net/2019/10/11/AbP95oHvd8zBNZw.png" alt="image.png"></p>
<p>Modify the <code>Makefile</code> file in the root directory of the source code</p>
<p><img src="https://i.loli.net/2019/10/11/Poy1enD354MLrBK.png" alt="image.png"></p>
<p>Complete the regular three-step <code>include/linux/syscalls.h</code>, <code>arch/x86/entry/syscalls/syscall_32.tbl</code> and <code>arch/x86/entry/syscalls/syscall_64.tbl</code></p>
<p><img src="https://i.loli.net/2019/10/11/CUWtY8eIc3pLA2i.png" alt="image.png"><br><img src="https://i.loli.net/2019/10/11/fDSu4HFQITmdsEX.png" alt="image.png"></p>
<p>Then compile the kernel <code>make -j8 bzImage</code></p>
<p>Written a demo as usual</p>
<p><img src="https://i.loli.net/2019/10/11/sHCO1f6bwk3hr7d.png" alt="image.png"></p>
<p>Then an error occurs when running</p>
<p><img src="https://i.loli.net/2019/10/11/VqLH7NOflsbhPJM.png" alt="image.png"></p>
<p>Probably something went wrong when passing parameters?</p>
<h2 id="Related-Source-Code"><a href="#Related-Source-Code" class="headerlink" title="Related Source Code"></a>Related Source Code</h2><p><strong>find_get_pid(int nr)</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pid</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">atomic_t</span> count;						    <span class="comment">//Number of tasks currently using this process</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> level;				</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">tasks</span>[<span class="title">PIDTYPE_MAX</span>]；  //<span class="title">List</span> <span class="title">of</span> <span class="title">tasks</span> <span class="title">that</span> <span class="title">use</span> <span class="title">this</span> <span class="title">process</span></span></span><br><span class="line"><span class="class">    <span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">upid</span> <span class="title">numbers</span>[1];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">upid</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> nr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">pid_chain</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//find_get_pid(pid_t nr) is to get the process descriptor by the process number pid_t nr and add 1 to the count in the structure</span></span><br><span class="line"><span class="keyword">struct</span> pid *<span class="title function_">find_get_pid</span><span class="params">(<span class="type">pid_t</span> nr)</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">pid</span>;</span> </span><br><span class="line">    rcu_read_lock();  </span><br><span class="line">    pid = get_pid(find_vpid(nr));  </span><br><span class="line">    rcu_read_unlock();  </span><br><span class="line">    <span class="keyword">return</span> pid;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//其中，find_vpid(pid_t nr) returns the process descriptor, and get_pid(struct pid * kpid) adds 1 to count</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> pid *<span class="title function_">get_pid</span><span class="params">(<span class="keyword">struct</span> pid *pid)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (pid)</span><br><span class="line">                <span class="type">atomic_inc</span>(&amp;pid-&gt;count);</span><br><span class="line">        <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> pid *<span class="title function_">find_vpid</span><span class="params">(<span class="type">int</span> nr)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> find_pid_ns(nr, task_active_pid_ns(current));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>pid_task()</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Find pid_task by process descriptor</span></span><br><span class="line"><span class="keyword">struct</span> task_struct *<span class="title function_">pid_task</span><span class="params">(<span class="keyword">struct</span> pid *pid, <span class="keyword">enum</span> pid_type type)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">result</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (pid) &#123;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> *<span class="title">first</span>;</span></span><br><span class="line">                first = rcu_dereference_check(hlist_first_rcu(&amp;pid-&gt;tasks[type]),</span><br><span class="line">                                              lockdep_tasklist_lock_is_held());</span><br><span class="line">                <span class="keyword">if</span> (first)</span><br><span class="line">                        result = hlist_entry(first, <span class="keyword">struct</span> task_struct, pids[(type)].node);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>asmlinkage</strong><br>Inform the compiler to extract the function parameters from the stack only, not from the registers, because the system has already pressed the parameter values passed through the registers into the kernel stack before executing the service routine</p>
<p><strong>set_user_nice()</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">set_user_nice</span><span class="params">(<span class="keyword">struct</span> task_struct *p, <span class="type">long</span> nice)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">bool</span> queued, running;</span><br><span class="line">	<span class="type">int</span> old_prio, delta;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rq_flags</span> <span class="title">rf</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rq</span> *<span class="title">rq</span>;</span></span><br><span class="line">    <span class="comment">// rq is the ready queue, which is designed to be one ready queue per cpu, with local processes sorted on the local queue</span></span><br><span class="line">	<span class="comment">// If the current task&#x27;s nice value is already equal to the nice value to be set, just exit</span></span><br><span class="line">	<span class="comment">// From here we can see that the nice values range from -20 to 19</span></span><br><span class="line">	<span class="keyword">if</span> (task_nice(p) == nice || nice &lt; MIN_NICE || nice &gt; MAX_NICE)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We have to be careful, if called from sys_setpriority(),</span></span><br><span class="line"><span class="comment">	 * the task might be in the middle of scheduling on another CPU.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	rq = task_rq_lock(p, &amp;rf);</span><br><span class="line">	update_rq_clock(rq);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The RT priorities are set via sched_setscheduler(), but we still</span></span><br><span class="line"><span class="comment">	 * allow the &#x27;normal&#x27; nice value to be set - but as expected</span></span><br><span class="line"><span class="comment">	 * it wont have any effect on scheduling until the task is</span></span><br><span class="line"><span class="comment">	 * SCHED_DEADLINE, SCHED_FIFO or SCHED_RR:</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">// If the current process is a real-time process, </span></span><br><span class="line">    <span class="comment">// the scheduling strategy for real-time processes can also be divided into deadline/fifo/rr.</span></span><br><span class="line">	<span class="comment">// Setting the nice value for real-time processes is actually useless, </span></span><br><span class="line">    <span class="comment">// but here it is still set to p-&gt;static_prio after converting the nice value to priority </span></span><br><span class="line">	<span class="keyword">if</span> (task_has_dl_policy(p) || task_has_rt_policy(p)) &#123;</span><br><span class="line">		p-&gt;static_prio = NICE_TO_PRIO(nice);<span class="comment">// Change priority by edit nice value</span></span><br><span class="line">		<span class="keyword">goto</span> out_unlock;</span><br><span class="line">	&#125;</span><br><span class="line">	queued = task_on_rq_queued(p);</span><br><span class="line">	running = task_current(rq, p);</span><br><span class="line">	<span class="keyword">if</span> (queued)</span><br><span class="line">		dequeue_task(rq, p, DEQUEUE_SAVE | DEQUEUE_NOCLOCK);</span><br><span class="line">	<span class="keyword">if</span> (running)</span><br><span class="line">		put_prev_task(rq, p);</span><br><span class="line">	<span class="comment">// Set the nice value to priority in static_prio, #define NICE_TO_PRIO(nice) ((nice) + DEFAULT_PRIO)</span></span><br><span class="line">	<span class="comment">// The DEFAULT_PRIO value here is calculated to be 120.</span></span><br><span class="line">	<span class="comment">// From here you can also see that the priority-to-nice value should be subtracted from DEFAULT_PRIO </span></span><br><span class="line">    <span class="comment">// #define PRIO_TO_NICE(prio) ((prio) - DEFAULT_PRIO)</span></span><br><span class="line"> </span><br><span class="line">	p-&gt;static_prio = NICE_TO_PRIO(nice);</span><br><span class="line">	set_load_weight(p);</span><br><span class="line">	old_prio = p-&gt;prio;</span><br><span class="line">	p-&gt;prio = effective_prio(p);</span><br><span class="line">	delta = p-&gt;prio - old_prio;</span><br><span class="line">	<span class="comment">// If the task of the nice to be set is in the queue</span></span><br><span class="line">	<span class="keyword">if</span> (queued) &#123;</span><br><span class="line">		enqueue_task(rq, p, ENQUEUE_RESTORE | ENQUEUE_NOCLOCK);</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If the task increased its priority or is running and</span></span><br><span class="line"><span class="comment">		 * lowered its priority, then reschedule its CPU:</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="comment">// Reschedule rq if priority is increased and task is running or if priority is decreased.</span></span><br><span class="line">		<span class="keyword">if</span> (delta &lt; <span class="number">0</span> || (delta &gt; <span class="number">0</span> &amp;&amp; task_running(rq, p)))</span><br><span class="line">			resched_curr(rq);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// If the task to set the nice value is running, and since we are changing the priority of p here, reassign the task&#x27;s rq.</span></span><br><span class="line">	<span class="keyword">if</span> (running)</span><br><span class="line">		set_curr_task(rq, p);</span><br><span class="line">    out_unlock:</span><br><span class="line">	task_rq_unlock(rq, p, &amp;rf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="article-licensing box"><div class="licensing-title"><p>backup: Syscalls and problems encountered</p><p><a href="http://aslin.site/2022/03/09/backup-Syscalls-and-problems-encountered/">http://aslin.site/2022/03/09/backup-Syscalls-and-problems-encountered/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>ACce1er4t0r</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2022-03-09</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2022-03-10</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/03/09/backup-PAT/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">backup: PAT</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/03/09/backup-Configuring-the-kernel-environment-from-scratch/"><span class="level-item">backup: Configuring the kernel environment from scratch</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.jpeg" alt="ACce1er4t0r"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">ACce1er4t0r</p><p class="is-size-6 is-block">CTFer | Student</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>UF@CISE</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">10</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ACce1er4t0r"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com/"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/ACce1er4t0r"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/shiyin-lin-224388186/"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-03-17T05:59:48.000Z">2022-03-17</time></p><p class="title"><a href="/2022/03/17/PWN-Learning-CSAW-2017-Quals-pilot/">PWN Learning: CSAW 2017 Quals - pilot</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-03-17T04:51:25.000Z">2022-03-17</time></p><p class="title"><a href="/2022/03/17/Programming-Linux-Character-Driver/">Programming Linux Character Driver</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-03-09T10:10:34.000Z">2022-03-09</time></p><p class="title"><a href="/2022/03/09/Programming-Linux-Modules/">Programming Linux Modules</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-03-09T08:32:17.000Z">2022-03-09</time></p><p class="title"><a href="/2022/03/09/backup-PAT/">backup: PAT</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-03-09T08:08:21.000Z">2022-03-09</time></p><p class="title"><a href="/2022/03/09/backup-Syscalls-and-problems-encountered/">backup: Syscalls and problems encountered</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">March 2022</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li></ul></div></div></div><!--!--></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/book-one.svg" alt="Normal Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 ACce1er4t0r</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>