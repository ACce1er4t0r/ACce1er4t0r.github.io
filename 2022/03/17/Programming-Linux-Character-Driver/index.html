<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Programming Linux Character Driver - Normal Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Normal Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Normal Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Linux Character Driver"><meta property="og:type" content="article"><meta property="og:title" content="Programming Linux Character Driver"><meta property="og:url" content="http://aslin.site/2022/03/17/Programming-Linux-Character-Driver/"><meta property="og:site_name" content="Normal Blog"><meta property="og:description" content="Linux Character Driver"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://aslin.site/img/og_image.png"><meta property="article:published_time" content="2022-03-17T04:51:25.000Z"><meta property="article:modified_time" content="2022-03-17T05:57:13.415Z"><meta property="article:author" content="ACce1er4t0r"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://aslin.site/2022/03/17/Programming-Linux-Character-Driver/"},"headline":"Programming Linux Character Driver","image":["http://aslin.site/img/og_image.png"],"datePublished":"2022-03-17T04:51:25.000Z","dateModified":"2022-03-17T05:57:13.415Z","author":{"@type":"Person","name":"ACce1er4t0r"},"publisher":{"@type":"Organization","name":"Normal Blog","logo":{"@type":"ImageObject","url":"http://aslin.site/img/book-one.svg"}},"description":"Linux Character Driver"}</script><link rel="canonical" href="http://aslin.site/2022/03/17/Programming-Linux-Character-Driver/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/book-one.svg" alt="Normal Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/resume.pdf">Resume</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2022-03-17T04:51:25.000Z" title="3/17/2022, 12:51:25 AM">2022-03-17</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-03-17T05:57:13.415Z" title="3/17/2022, 1:57:13 AM">2022-03-17</time></span><span class="level-item">12 minutes read (About 1773 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Programming Linux Character Driver</h1><div class="content"><p>Linux Character Driver</p>
<span id="more"></span>

<h1 id="Character-Device-Structures"><a href="#Character-Device-Structures" class="headerlink" title="Character Device Structures"></a>Character Device Structures</h1><p>Character device driver, block device driver and network device driver as the linux kernel three major driver devices, character devices mainly complete the byte read and write operations, common applications are mouse, keyboard, etc., the structure form is shown below:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span>  <span class="comment">// Belonging modules</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">ops</span>;</span>  <span class="comment">// Character device operation method</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="type">dev_t</span> dev;     <span class="comment">// Device</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>The dev_t in the cdev structure represents the 32-bit device number, 12 bits are the major device number and 20 bits are the minor device number. The major device number and minor device number can be obtained from the dev_t by macro definitions MAJOR(dev_t dev) and MINOR(dev_t dev). In addition, dev_t can be generated from the primary and secondary device numbers using the macro definition MKDEV(int major, int minor).</li>
<li>The Linux kernel provides a set of functions to operate on character device structures, which can be used to manipulate the cdev structure.</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">cdev_init</span><span class="params">(<span class="keyword">struct</span> cdev *, <span class="keyword">struct</span> file_operations *)</span>;  <span class="comment">// Used to initialize the members of cdev and establish the connection between cdev and file_operation</span></span><br><span class="line"><span class="keyword">struct</span> cdev *<span class="title function_">cdev_alloc</span><span class="params">(<span class="type">void</span>)</span>;  <span class="comment">// Used to dynamically request a cdev memory</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cdev_put</span><span class="params">(<span class="keyword">struct</span> cdev *p)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">cdev_add</span><span class="params">(<span class="keyword">struct</span> cdev *, <span class="type">dev_t</span>, <span class="type">unsigned</span>)</span>;  <span class="comment">// Add a cdev to the system to complete the registration of the character device. The call to cdev_add() usually occurs in the character device driver module load function</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cdev_del</span><span class="params">(<span class="keyword">struct</span> cdev *)</span>;  <span class="comment">// Deleting a cdev completes the cancellation of the character device. The call to the cdev_del() function usually occurs in the uninstall function of the character device driver module</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Call register_chrdev_region() or alloc_chrdev_region() function to request a device number from the system, and then call cdev_add() function to register the character device with the system.</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">register_chrdev_region</span><span class="params">(<span class="type">dev_t</span> from, <span class="type">unsigned</span> count, <span class="type">const</span> <span class="type">char</span> *name)</span>;  <span class="comment">// Known starting device number</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">alloc_chrdev_region</span><span class="params">(<span class="type">dev_t</span> *dev, <span class="type">unsigned</span> baseminor, <span class="type">unsigned</span> count,<span class="type">const</span> <span class="type">char</span> *name)</span>;  <span class="comment">// Unknown starting device number</span></span><br></pre></td></tr></table></figure>

<ul>
<li>The member functions in the file_operations structure are eventually called by the kernel when the application makes Linux system calls such as open(), write(), read(), close(), etc.<ul>
<li>llseek() modifies the current read&#x2F;write location of a file and returns the new location, returning a negative value in case of error.</li>
<li>read() reads data from the device, returning the number of bytes read on success and a negative value on error. Corresponds to ssize_t read (int fd, void<em>buf, size_t count) and size_t fread (void</em>ptr, size_t size, size_t nmemb, FILE*stream) in user space applications.</li>
<li>write() sends data to the device and returns the number of bytes written on success. If this function is not implemented, the user will get the -EINVAL return value when making the write() system call. Corresponds to ssize_t write (int fd, constvoid<em>buf, size_t count) and size_t fwrite (const void</em>ptr, size_t size, size_t nmemb, FILE*stream) in user space applications.</li>
<li>read() and write() indicate end-of-file (EOF) if they return 0.</li>
<li>unlocked_ioctl() provides implementation of device-related control commands (neither read nor write operations) and returns a non-negative value to the calling program when called successfully. It is similar to the user-space application calls int fcntl (int fd, int cmd, … &#x2F;<em>arg</em>&#x2F;) and intioctl (int d, int request, …) counterparts.</li>
<li>mmap() maps device memory into the virtual address space of the process. If the device driver does not implement this function, the user will get the -ENODEV return value when making the mmap() system call. This function is of particular interest for devices such as frame buffers, which are mapped into user space so that applications can access them directly without having to copy memory between the kernel and the application. It corresponds to the void<em>mmap (void</em>addr, size_t length, int prot, int flags, int fd, off_t offset) function in user space applications.</li>
</ul>
</li>
<li>The functions for loading and unloading the character device driver module are as follows<ul>
<li>static int __init mydev_init(void) </li>
<li>static void __exit mydev_exit(void)</li>
<li>The application of device number and registration of cdev should be implemented in the load function of the character device driver module, while the release of device number and cancellation of cdev should be implemented in the unload function.</li>
</ul>
</li>
</ul>
<h1 id="Character-Structures-Programming"><a href="#Character-Structures-Programming" class="headerlink" title="Character Structures Programming"></a>Character Structures Programming</h1><blockquote>
<p>Create a new dev folder and create mydev.c and the corresponding Makefile file in this directory</p>
</blockquote>
<p>The mydev.c program is as follows:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MYDEV_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MEM_CLEAR 0x1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MYDEV_MAJOR 230</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> mydev_major = MYDEV_MAJOR;  <span class="comment">//Define the major device number</span></span><br><span class="line">module_param(mydev_major, <span class="type">int</span>, S_IRUGO);  <span class="comment">// module parameter passing</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mydev_dev</span> &#123;</span>   <span class="comment">// Define the mydevmen_dev structure</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span>  <span class="comment">// Character Structures</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> mem[MYDEV_SIZE];  <span class="comment">// Memory</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mydev_dev</span> * <span class="title">mydev_devp</span>;</span><span class="comment">// Declare the mydev structure object</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Read function of mydev device driver</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">mydev_read</span><span class="params">(<span class="keyword">struct</span> file * filp, <span class="type">char</span> __user * buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> * ppos)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> p = *ppos;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> count = size;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mydev_dev</span> * <span class="title">dev</span> =</span> filp-&gt;private_data;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (p &gt;= MYDEV_SIZE) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (count &gt; MYDEV_SIZE - p) &#123;</span><br><span class="line">        count = MYDEV_SIZE - p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(buf, dev-&gt;mem + p, count)) &#123;</span><br><span class="line">        ret = -EFAULT;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *ppos += count;</span><br><span class="line">        ret = count;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;read %u bytes(s) from %lu\n&quot;</span>, count, p);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Write function for mydev device driver</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">mydev_write</span><span class="params">(<span class="keyword">struct</span> file * filp, <span class="type">const</span> <span class="type">char</span> __user * buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> * ppos)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> p = *ppos;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> count = size;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mydev_dev</span> * <span class="title">dev</span> =</span> filp-&gt;private_data;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (p &gt;= MYDEV_SIZE) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (count &gt; MYDEV_SIZE - p) &#123;</span><br><span class="line">        count = MYDEV_SIZE - p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(dev-&gt;mem + p, buf, count)) &#123;</span><br><span class="line">        ret = -EFAULT;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *ppos += count;</span><br><span class="line">        ret = count;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;written %u bytes(s) from %lu\n&quot;</span>, count, p);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Addressing functions</span></span><br><span class="line"><span class="type">static</span> <span class="type">loff_t</span> <span class="title function_">mydev_llseek</span><span class="params">(<span class="keyword">struct</span> file * filp, <span class="type">loff_t</span> offset, <span class="type">int</span> flag)</span> &#123;</span><br><span class="line">    <span class="type">loff_t</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">switch</span> (flag) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">/* Seek from the beginning of the file */</span></span><br><span class="line">            <span class="keyword">if</span> (offset&lt; <span class="number">0</span> || (<span class="type">unsigned</span> <span class="type">int</span>)offset &gt; MYDEV_SIZE) &#123;</span><br><span class="line">                ret = -EINVAL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            filp-&gt;f_pos = (<span class="type">unsigned</span> <span class="type">int</span>)offset;</span><br><span class="line">            ret = filp-&gt;f_pos;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">/* Seek from the current location of the file */</span></span><br><span class="line">            <span class="keyword">if</span> ((filp-&gt;f_pos + offset) &gt; MYDEV_SIZE || (filp-&gt;f_pos + offset) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                ret = -EINVAL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            filp-&gt;f_pos += offset;</span><br><span class="line">            ret = filp-&gt;f_pos;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            ret = -EINVAL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">mydev_ioctl</span><span class="params">(<span class="keyword">struct</span> file * filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mydev_dev</span> * <span class="title">dev</span> =</span> filp-&gt;private_data;</span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> MEM_CLEAR:</span><br><span class="line">            <span class="built_in">memset</span>(dev-&gt;mem, <span class="number">0</span>, MYDEV_SIZE);</span><br><span class="line">            printk(KERN_INFO <span class="string">&quot;mydev is set to zero\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// open function</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mydev_open</span><span class="params">(<span class="keyword">struct</span> inode * inode, <span class="keyword">struct</span> file *filp)</span> &#123;</span><br><span class="line">    filp-&gt;private_data = mydev_devp;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// release function</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mydev_release</span><span class="params">(<span class="keyword">struct</span> inode * inode, <span class="keyword">struct</span> file * filp)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Define the character structure method</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">mydev_fops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .llseek = mydev_llseek,</span><br><span class="line">    .read = mydev_read,</span><br><span class="line">    .write = mydev_write,</span><br><span class="line">    .unlocked_ioctl = mydev_ioctl,</span><br><span class="line">    .open = mydev_open,</span><br><span class="line">    .release = mydev_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Character device setup functions</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">mydev_setup_cdev</span><span class="params">(<span class="keyword">struct</span> mydev_dev * dev, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="type">int</span> err, devno = MKDEV(mydev_major, index);  <span class="comment">// Get the device structure dev_t</span></span><br><span class="line">    </span><br><span class="line">    cdev_init(&amp;dev-&gt;cdev, &amp;mydev_fops);  <span class="comment">// Initialization of character devices and character device handling methods</span></span><br><span class="line">    dev-&gt;cdev.owner = THIS_MODULE;  <span class="comment">// Initialize the module to which the character device belongs</span></span><br><span class="line">    err = cdev_add(&amp;dev-&gt;cdev, devno, <span class="number">1</span>);  <span class="comment">// Add a character device</span></span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        printk(KERN_NOTICE <span class="string">&quot;Error %d adding mydev%d&quot;</span>, err, index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Module initialization</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">mydev_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">dev_t</span> devno = MKDEV(mydev_major, <span class="number">0</span>);  <span class="comment">// Get the character device structure</span></span><br><span class="line">    <span class="keyword">if</span> (mydev_major) &#123;</span><br><span class="line">        ret = register_chrdev_region(devno, <span class="number">1</span>, <span class="string">&quot;mydev&quot;</span>);  <span class="comment">// Register this cdev device, the second parameter is the number</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ret = alloc_chrdev_region(&amp;devno, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;mydev&quot;</span>);  <span class="comment">// Request character device cdev space, the second parameter is the base, the third is the number</span></span><br><span class="line">        mydev_major = MAJOR(devno);  <span class="comment">// Get the major device number</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    mydev_devp = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> mydev_dev), GFP_KERNEL);  <span class="comment">// Allocate mydev structure internal memory</span></span><br><span class="line">    <span class="keyword">if</span> (!mydev_devp) &#123;</span><br><span class="line">        ret = -ENOMEM;</span><br><span class="line">        <span class="keyword">goto</span> fail_malloc;    <span class="comment">//Jump if assignment fails</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The differenct between major and minor equipment</span></span><br><span class="line">    mydev_setup_cdev(mydev_devp, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;    </span><br><span class="line">fail_malloc:</span><br><span class="line">    unregister_chrdev_region(devno, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(mydev_init);</span><br><span class="line"><span class="comment">// Module uninstall function</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">mydev_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    cdev_del(&amp;mydev_devp-&gt;cdev);</span><br><span class="line">    kfree(mydev_devp);</span><br><span class="line">    unregister_chrdev_region(MKDEV(mydev_major, <span class="number">0</span>), <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">module_exit(mydev_exit);</span><br><span class="line"></span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;AC&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL v2&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>The Makefile program is as follows:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mydev.o</span><br><span class="line"></span><br><span class="line">KDIR := /home/test/test_kernel/linux-5.3.2</span><br><span class="line">PWD :=<span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line"><span class="section">default:</span></span><br><span class="line">	make -C <span class="variable">$(KDIR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	make -C <span class="variable">$(KDIR)</span> M=<span class="variable">$(PWD)</span> clean</span><br></pre></td></tr></table></figure>

<h1 id="Character-device-validation"><a href="#Character-device-validation" class="headerlink" title="Character device validation"></a>Character device validation</h1><ul>
<li>Enter the make command in the mydev directory</li>
<li>First <code>dmesg -c</code></li>
<li>Then insert the module as administrator and type insmod mydev.ko in the mydev directory</li>
<li><code>cat /proc/devices</code> </li>
<li>Enter characters into this character device to create a device node: mknod &#x2F;dev&#x2F;mydev c 230 0 &#x2F;&#x2F;230 0 is the primary and secondary device number of the device you created; write the string: echo “hello world!”&gt;&#x2F;dev&#x2F;mydev; check the input information: cat &#x2F;dev&#x2F;mydev; check the read&#x2F;write situation: dmesg mydev</li>
</ul>
<h1 id="Test-Code"><a href="#Test-Code" class="headerlink" title="Test Code"></a>Test Code</h1><p>Create the mydevTest.c test file with the following code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	<span class="type">char</span> s[] = <span class="string">&quot;OvO\nTest,TeSt,Te5t,tesTte5T,tesT\n&quot;</span>;</span><br><span class="line">	<span class="type">char</span> buffer[<span class="number">80</span>];</span><br><span class="line">	<span class="type">int</span> fd=open(<span class="string">&quot;/dev/mydev&quot;</span>, O_RDWR);  <span class="comment">//  Open mydev device, fd returns a number greater than 2 then success, O_RDWR for permission to give</span></span><br><span class="line">	<span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		write(fd, s, <span class="keyword">sizeof</span>(s));</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;---Write something to mydev---\n%d\n%s\n&quot;</span>, fd, s);</span><br><span class="line">		close(fd);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;fd = %d, seems there are some error...\n&quot;</span>, fd);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (fd = open(<span class="string">&quot;/dev/mydev&quot;</span>, O_RDWR) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		read(fd, buffer, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;---Read something from mydev---\n%d\n%s\n&quot;</span>, fd, buffer);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;fd = %d, seems there are some error...\n&quot;</span>, fd);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Type gcc mydevTest.c a.out to generate a.out, then type . &#x2F;a.out to run.</p>
</blockquote>
<p>mydev: loading out-of-tree module taints kernel.<br>mydev: module verification failed: signature and&#x2F;or required key missing - tainting kernel</p>
<p>are the very beginning of the Linux source code .config, which will be shown in this experiment but does not affect</p>
<p>If there is no CONFIG_MODULE_SIG&#x3D;n statement in the Makefile file, then the hello.txt file will show </p>
<p>module verification failed: signature and&#x2F;or required key missing - tainting kernel<br>i.e.: Module verification failed.</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Programming Linux Character Driver</p><p><a href="http://aslin.site/2022/03/17/Programming-Linux-Character-Driver/">http://aslin.site/2022/03/17/Programming-Linux-Character-Driver/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>ACce1er4t0r</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2022-03-17</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2022-03-17</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/03/17/PWN-Learning-CSAW-2017-Quals-pilot/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">PWN Learning: CSAW 2017 Quals - pilot</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/03/09/Programming-Linux-Modules/"><span class="level-item">Programming Linux Modules</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.jpeg" alt="ACce1er4t0r"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">ACce1er4t0r</p><p class="is-size-6 is-block">CTFer | Student</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>UF@CISE</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">10</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ACce1er4t0r"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com/"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/ACce1er4t0r"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/shiyin-lin-224388186/"><i class="fab fa-linkedin"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-03-17T05:59:48.000Z">2022-03-17</time></p><p class="title"><a href="/2022/03/17/PWN-Learning-CSAW-2017-Quals-pilot/">PWN Learning: CSAW 2017 Quals - pilot</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-03-17T04:51:25.000Z">2022-03-17</time></p><p class="title"><a href="/2022/03/17/Programming-Linux-Character-Driver/">Programming Linux Character Driver</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-03-09T10:10:34.000Z">2022-03-09</time></p><p class="title"><a href="/2022/03/09/Programming-Linux-Modules/">Programming Linux Modules</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-03-09T08:32:17.000Z">2022-03-09</time></p><p class="title"><a href="/2022/03/09/backup-PAT/">backup: PAT</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-03-09T08:08:21.000Z">2022-03-09</time></p><p class="title"><a href="/2022/03/09/backup-Syscalls-and-problems-encountered/">backup: Syscalls and problems encountered</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">March 2022</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li></ul></div></div></div><!--!--></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/book-one.svg" alt="Normal Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 ACce1er4t0r</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>